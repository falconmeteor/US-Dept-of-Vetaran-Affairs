{
    "type" : "monitor",
    "schema_version" : 3,
    "name" : "gss-aws-afterhours-console-login",
    "enabled" : true,
    "schedule" : {
      "cron" : {
        "expression" : "0 0-6 * * *",
        "timezone" : "America/New_York"
      }
    },
    "inputs" : [
      {
        "search" : {
          "indices" : [
            "awslogs*"
          ],
          "query" : {
            "size" : 0,
            "query" : {
              "bool" : {
                "must" : [
                  {
                    "match" : {
                      "source" : {
                        "query" : "aws.signin",
                        "operator" : "OR",
                        "prefix_length" : 0,
                        "max_expansions" : 50,
                        "fuzzy_transpositions" : true,
                        "lenient" : false,
                        "zero_terms_query" : "NONE",
                        "auto_generate_synonyms_phrase_query" : true,
                        "boost" : 1.0
                      }
                    }
                  }
                ],
                "filter" : [
                  {
                    "range" : {
                      "@timestamp" : {
                        "from" : "{{period_end}}||-1h",
                        "to" : "{{period_end}}",
                        "include_lower" : true,
                        "include_upper" : true,
                        "format" : "epoch_millis",
                        "boost" : 1.0
                      }
                    }
                  },
				  {
                    "terms" : {
                      "account" : [
                        "348021725816",
                        "348286891446",
                        "558384143803",
                        "479075246528",
                        "804298029709",
                        "311937954251"
                      ],
                      "boost" : 1.0
                    }
                  }
                ],
                "adjust_pure_negative" : true,
                "boost" : 1.0
              }
            },
            "aggregations" : {
              "account" : {
                "terms" : {
                  "field" : "account.keyword",
                  "size" : 10,
                  "min_doc_count" : 1,
                  "shard_min_doc_count" : 0,
                  "show_term_doc_count_error" : false,
                  "order" : [
                    {
                      "_count" : "desc"
                    },
                    {
                      "_key" : "asc"
                    }
                  ]
                },
                "aggregations" : {
                  "user" : {
                    "terms" : {
                      "field" : "detail.userIdentity.arn.keyword",
                      "size" : 10,
                      "min_doc_count" : 1,
                      "shard_min_doc_count" : 0,
                      "show_term_doc_count_error" : false,
                      "order" : [
                        {
                          "_count" : "desc"
                        },
                        {
                          "_key" : "asc"
                        }
                      ]
                    }
                  }
                }
              }
            }
          }
        }
      }
    ],
    "triggers" : [
      {
        "name" : "gss-aws-afterhours-console-login",
        "severity" : "4",
        "condition" : {
          "script" : {
            "source" : "ctx.results[0].hits.total.value > 0",
            "lang" : "painless"
          }
        },
        "actions" : [
          {
            "name" : "Send Email COMS",
            "destination_id" : "F8JG53IBz9Q1aMdkB9FZ",
            "message_template" : {
              "source" : """Monitor {{ctx.monitor.name}} just entered alert status. Please investigate the issue.
- Trigger: {{ctx.trigger.name}}
- Severity: {{ctx.trigger.severity}}
- Period start: {{ctx.periodStart}}
- Period end: {{ctx.periodEnd}}

{{#ctx.results}}
{{#aggregations.account.buckets}}
Account: {{key}}
{{#user.buckets}}
     User: {{key}}
{{/user.buckets}}
{{/aggregations.account.buckets}}
{{/ctx.results}}

SEV 1:
    Definition:  Immediate action is required meaning something is down or a feature that has been working in the past currently is not working.
    ECSD Working Hours Action:  Callout
    ECSD After Hours Action: Callout

SEV 2:
    Definition: Action is required within 2 hours to possibly prevent an outage or an upgrade to SEV 1.
    ECSD Working Hours Action:  Ignore
    ECSD After Hours Action: Callout

SEV 3:
    Definition:  An alert that has no potential to cause a higher SEV Level within 1 Day.
    ECSD Working Hours Action: Ignore
    ECSD After Hours Action: Ignore

SEV 4:
    Definition: Informational alert such as privilege escalation.  This information has no action, however needs to be reviewed.
    ECSD Working Hours Action: Ignore
    ECSD After Hours Action: Ignore

SEV 5:
    Definition: Informational alert for non-privilege escalation.  This information has no action, however needs to be reviewed.
    ECSD Working Hours Action: Ignore
    ECSD After Hours Action: Ignore

""",
              "lang" : "mustache"
            },
            "throttle_enabled" : false,
            "subject_template" : {
              "source" : "gss-aws-afterhours-console-login",
              "lang" : "mustache"
            }
          }
        ]
      }
    ]
}
